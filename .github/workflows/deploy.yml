name: ğŸš€ Deploy Frontend to Orange Pi

on:
  push:
    branches:
      - master  # Only deploy on master branch

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORANGE_PI_HOST }}
          username: ${{ secrets.ORANGE_PI_USER }}
          key: ${{ secrets.ORANGE_PI_SSH_KEY }}
          port: 22
          script: |
            set -e  # Exit on any error
            
            echo "================================================"
            echo "ğŸš€ Starting Frontend Deployment"
            echo "================================================"
            
            # Navigate to project directory
            cd ~/Projects/MyFinances/frontend/minhas-financas-app || exit 1
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/master
            
            # Build Docker image with production API URL
            echo "ğŸ³ Building Docker image..."
            sudo docker build \
              --build-arg NEXT_PUBLIC_API_URL=https://api.hardman.app.br \
              -t my-finances-frontend:latest .
            
            # Stop old container
            echo "ğŸ›‘ Stopping old container..."
            sudo docker stop my-finances-app || true
            sudo docker rm my-finances-app || true
            
            # Run new container
            echo "â–¶ï¸  Starting new container..."
            sudo docker run -d \
              -p 3000:3000 \
              --name my-finances-app \
              --restart unless-stopped \
              my-finances-frontend:latest
            
            # Wait for container to start
            echo "â³ Waiting for container to start..."
            sleep 5
            
            # Verify container is running
            if sudo docker ps | grep -q my-finances-app; then
              echo "âœ… Container is running!"
            else
              echo "âŒ Container failed to start!"
              sudo docker logs my-finances-app
              exit 1
            fi
            
            # Clean up old images
            echo "ğŸ§¹ Cleaning up old Docker images..."
            sudo docker image prune -f
            
            # Show container status
            echo "ğŸ“Š Container Status:"
            sudo docker ps -a | grep my-finances-app
            
            echo "================================================"
            echo "âœ… Frontend Deployment Complete!"
            echo "ğŸŒ App: https://hardman.app.br"
            echo "================================================"
      
      - name: ğŸ“¢ Notify on Success
        if: success()
        run: echo "âœ… Frontend deployed successfully to Orange Pi!"
      
      - name: ğŸ“¢ Notify on Failure
        if: failure()
        run: echo "âŒ Frontend deployment failed! Check logs above."